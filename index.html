<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jung Purpose Topic Forge – Advanced</title>
  <!--
    This tool is designed as a self‑contained interactive app that helps
    first‑semester community college students discover energising topics
    for informative speeches.  It uses a Jungian framing—individuation,
    finality, vocation and consciousness—as inspiration, but keeps the
    language accessible and practical.  User data stays local: everything
    is stored in the browser’s localStorage and can be exported as a
    simple text file at the end of the session.  The question sequence
    adapts based on user responses: after the core prompts, two
    follow‑up prompts are generated that target detected interest areas.
    The synthesis includes purpose hypotheses, topic seeds, research
    questions, outline starters, and a speakable oral citation template.
  -->
  <style>
    :root{
      --ink:#0A3D62;
      --ink2:#145388;
      --bg:#F9FAFB;
      --card:#FFFFFF;
      --muted:#6B7280;
      --accent:#2563EB;
      --teal:#14B8A6;
      --radius:14px;
      --shadow:0 6px 20px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);line-height:1.5;}
    header{position:sticky;top:0;background:linear-gradient(180deg,#fff,rgba(255,255,255,.9));backdrop-filter:saturate(1.5) blur(6px);border-bottom:1px solid #E5E7EB;z-index:100;padding:10px 0;}
    .wrap{max-width:920px;margin:0 auto;padding:0 16px;}
    .brand{display:flex;align-items:center;gap:12px;}
    .brand h1{font-size:20px;font-weight:600;color:var(--ink);}
    .pill{margin-left:auto;font-size:12px;background:var(--accent);color:#fff;padding:4px 10px;border-radius:999px;white-space:nowrap;}
    main{padding:16px 0 32px;}
    .card{background:var(--card);border:1px solid #E5E7EB;border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:16px 0;}
    h2{margin-bottom:8px;font-size:22px;font-weight:600;color:var(--ink);}
    h3{margin-top:16px;margin-bottom:6px;font-size:18px;font-weight:600;color:var(--ink);}
    p{margin-bottom:12px;}
    .muted{color:var(--muted);font-size:14px;}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px;}
    button{background:var(--ink);color:#fff;border:0;border-radius:8px;padding:10px 16px;font-size:15px;cursor:pointer;transition:background .2s ease;}
    button.secondary{background:#E5E7EB;color:var(--ink);} 
    button.ghost{background:transparent;border:1px solid #D1D5DB;color:var(--ink);} 
    button:disabled{opacity:.5;cursor:not-allowed;}
    input[type=text], textarea, select{
      width:100%;border:1px solid #D1D5DB;border-radius:8px;padding:10px;font-size:15px;background:#fff;
    }
    textarea{resize:vertical;min-height:100px;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
    .chip{padding:6px 12px;border:1px solid #D1D5DB;border-radius:999px;background:#fff;font-size:14px;cursor:pointer;user-select:none;}
    .chip.active{background:var(--accent);border-color:var(--accent);color:#fff;}
    .progress{height:6px;background:#EDF2F7;border-radius:999px;overflow:hidden;margin-top:8px;}
    .bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--teal));width:0%;}
    .question-header{display:flex;align-items:center;gap:12px;margin-bottom:8px;}
    .qnum{background:var(--ink);color:#fff;border-radius:999px;display:flex;align-items:center;justify-content:center;min-width:28px;height:28px;font-weight:600;}
    .hint{font-size:13px;color:var(--muted);}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    @media(max-width:640px){.grid{grid-template-columns:1fr;}}
    .output pre{background:#0B172A;color:#E5ECF3;padding:14px;border-radius:8px;overflow:auto;font-size:14px;white-space:pre-wrap;}
    details summary{cursor:pointer;margin-top:8px;margin-bottom:4px;font-weight:500;color:var(--ink2);}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #D1D5DB;margin-right:6px;}
    .badge.good{background:#ECFDF5;color:#065F46;border-color:#A7F3D0;}
    footer{margin-top:32px;font-size:13px;color:var(--muted);}
  </style>
</head>
<body>
<header>
  <div class="wrap brand">
    <h1>Jung Purpose Topic Forge • Advanced</h1>
    <span class="pill">Adaptive &amp; Private</span>
  </div>
</header>
<main class="wrap">
  <!-- Intro section -->
  <section class="card" id="intro">
    <h2>Discover energy and craft informative topics</h2>
    <p class="muted">This guided exercise combines questions about your past, your values and your callings.  It adapts follow‑up prompts based on your answers, then helps you turn themes into three informative speech seeds plus research questions and outline starters.  All data stays on your device.  Export a final summary for your records.</p>
    <ul style="margin-left:16px;margin-bottom:12px;color:var(--ink);">
      <li><strong>Time:</strong> about 15&nbsp;minutes</li>
      <li><strong>What you need:</strong> an open mind, honesty and a willingness to explore what energises you</li>
      <li><strong>Outcome:</strong> 3 personalised topic seeds, 3 research questions, outline starters &amp; a speakable citation line</li>
    </ul>
    <div class="controls">
      <button id="start">Begin</button>
      <button class="secondary" id="load">Load saved</button>
      <button class="ghost" id="clear">Clear saved</button>
    </div>
  </section>

  <!-- Question engine -->
  <section class="card" id="engine" hidden>
    <div class="question-header">
      <div class="qnum" id="qnum">1</div>
      <div>
        <h2 id="qtitle">Question title</h2>
        <div class="hint" id="qhint">Question hint</div>
      </div>
      <div style="margin-left:auto;font-size:12px;color:var(--muted);"><span id="progressLabel">0%</span></div>
    </div>
    <div id="qbody"></div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <div class="controls" style="margin-top:16px;">
      <button class="secondary" id="prev">Back</button>
      <button id="next">Next</button>
      <button class="ghost" id="skip">Skip</button>
    </div>
  </section>

  <!-- Results output -->
  <section class="card" id="results" hidden>
    <h2>Your personalised synthesis</h2>
    <p class="muted">Below are your preliminary purpose statements and derived topics.  Edit them if needed before exporting.</p>
    <div class="grid">
      <div>
        <h3>Purpose hypotheses</h3>
        <ul id="hypotheses"></ul>
      </div>
      <div>
        <h3>Topic seeds</h3>
        <ol id="seeds"></ol>
      </div>
    </div>
    <h3>Research questions</h3>
    <ol id="rqs"></ol>
    <h3>Outline starters</h3>
    <div id="outlines"></div>
    <h3>Speakable oral citation template</h3>
    <p class="muted">Fill in the blanks and practice reading it aloud: “According to <strong>[who]</strong>, in <strong>[year]</strong>, in <strong>[source]</strong>, <strong>[finding]</strong>. For our class this matters because <strong>[audience fit]</strong>.”</p>
    <div class="controls">
      <button id="export">Export summary (.txt)</button>
      <button class="secondary" id="save">Save progress</button>
      <button class="ghost" id="restart">Start over</button>
    </div>
    <details>
      <summary>Why these questions?</summary>
      <p class="small" style="margin-top:8px;">The core prompts explore your childhood fascinations, energising activities, challenges, values and responsibilities.  Jung held that purpose emerges from integrating unconscious material with conscious life (individuation) and by following compelling calls (vocation).  Adaptive follow‑ups surface overlooked interests.  The synthesis translates your reflections into neutral, informative topics, researchable questions and simple patterns you can teach.</p>
    </details>
  </section>

  <footer>
    <p><strong>Instructor notes:</strong> Primary Jungian anchors for this exercise include his statement that “the sole purpose of human existence is to kindle a light in the darkness of mere being” from <em>Memories, Dreams, Reflections</em>【303496181562033†L13-L20】 and his view that neuroses can be understood from both causal and teleological standpoints【887644235064197†L2269-L2273】.  These support the focus on consciousness and forward‑looking direction.</p>
  </footer>
</main>

<!-- JavaScript logic -->
<script>
/*
  Data model: Questions is an array of objects. Each object defines:
  - id: unique key stored in state
  - title: the displayed question
  - hint: supporting guidance
  - render(target, value): renders input fields and returns a function to
    retrieve current value(s)

  After the core questions, two adaptive follow‑up prompts are inserted based
  on detected interest categories (arts, helping, tech, nature, health, justice,
  business).  Category detection uses simple keyword counts from textual
  answers.
*/

const STORAGE_KEY = 'jung_purpose_forge_v2';
let state = { index: 0, answers: {} };

// Keyword clusters used to detect interest categories
const keywords = {
  arts: ['art','draw','painting','design','music','sing','dance','film','photography','writing','fashion','poetry','creative'],
  helping: ['help','mentor','teach','support','care','volunteer','serve','nurse','coach','tutor','listen'],
  tech: ['code','program','technology','robot','computer','ai','cyber','gadget','software','hardware','data'],
  nature: ['nature','hike','hiking','garden','animals','ocean','forest','mountain','river','outdoors','plants'],
  health: ['health','exercise','fitness','nutrition','mental','wellness','therapy','meditation','yoga','sleep','medicine'],
  justice: ['justice','equity','rights','community','policy','civic','advocacy','environment','climate','gender','race'],
  business: ['business','entrepreneur','startup','marketing','finance','invest','sell','ecommerce','management']
};

// Crosswalk mapping from selected Jungian archetype to interest categories.
// When a student selects an archetype, its mapped categories are boosted in
// detection.  This helps personalise follow‑ups and seed suggestions.
const archetypeCategories = {
  Explorer: ['nature','business'],
  Caregiver: ['helping','health'],
  Hero: ['justice','health'],
  Creator: ['arts','business'],
  Sage: ['tech','justice'],
  Rebel: ['business','justice'],
  Innocent: ['nature','health'],
  Ruler: ['business','helping']
};

// Library of seed suggestions keyed by category.  Each category contains
// several informative topics.  During synthesis we will pick from these
// lists to fill any gaps in the student’s own proposals.
const seedSuggestions = {
  arts: [
    'How creativity boosts learning and memory',
    'The neuroscience of inspiration and idea generation',
    'From doodle to design: the process of concept art',
    'The history of jazz and its cultural impact'
  ],
  helping: [
    'The psychology of mentoring: why it works',
    'How volunteering benefits mental health',
    'Conflict resolution basics for teams',
    'The science of peer tutoring and retention'
  ],
  tech: [
    'What machine learning is and isn’t',
    'How encryption keeps your data safe',
    'What blockchain means and why it matters',
    'How social media algorithms influence behaviour'
  ],
  nature: [
    'How pollination works and why bees matter',
    'The water cycle explained in everyday language',
    'What rewilding is and its environmental impact',
    'How urban green spaces improve mental health'
  ],
  health: [
    'The stress response and how to regulate it',
    'Why sleep matters for memory and mood',
    'How sugar affects the brain and body',
    'Benefits of meditation backed by science'
  ],
  justice: [
    'Implicit bias: definition and examples',
    'How redlining shaped American cities',
    'What environmental justice means and why it matters',
    'How voting rights have changed over time'
  ],
  business: [
    'The basics of entrepreneurship and start‑ups',
    'How compound interest works and why to start early',
    'What intellectual property is and why protect it',
    'How supply chains deliver goods to your door'
  ]
};

// Utility to create chip selectors
function createChips(options, initial = []) {
  const container = document.createElement('div');
  container.className = 'chips';
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'chip';
    btn.textContent = opt;
    if (initial.includes(opt)) btn.classList.add('active');
    btn.onclick = () => {
      btn.classList.toggle('active');
    };
    container.appendChild(btn);
  });
  container.getValue = () => Array.from(container.querySelectorAll('.chip.active')).map(el => el.textContent);
  container.setValue = vals => {
    container.querySelectorAll('.chip').forEach(btn => btn.classList.toggle('active', vals.includes(btn.textContent)));
  };
  return container;
}

// Core questions definition
const coreQuestions = [
  {
    id: 'name',
    title: 'What is your name (first & last initial)?',
    hint: 'Used only for your export; optional.',
    render(target, value = '') {
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'e.g., Jordan R.';
      input.value = value;
      target.appendChild(input);
      return () => input.value.trim();
    }
  },
  {
    id: 'childhood',
    title: 'What captivated you as a child?',
    hint: 'List small fascinations, recurring interests or activities (ages ~7–14).',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'Dinosaurs, fixing things, drawing shoes, acting, maps…';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  },
  {
    id: 'flow',
    title: 'When do you feel most alive and lose track of time?',
    hint: 'Describe two or three activities in the last year that absorbed you.',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'Playing guitar for friends, gaming, trail running, debating, building PCs…';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  },
  {
    id: 'challenge',
    title: 'Recall a challenge you overcame or a fear you faced.',
    hint: 'What did you learn about yourself from this experience?',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'Public speaking, moving to a new country, passing a difficult exam…';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  },
  {
    id: 'topics',
    title: 'List a few issues or topics in the world that stir you.',
    hint: 'Pick areas you’d like to explore or problems you’d like to solve.',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'Mental health stigma, climate change, misinformation, personal finance, AI ethics…';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  },
  {
    id: 'speak30',
    title: 'What could you talk about for 30 minutes without notes?',
    hint: 'These are natural starting points for informative talks.',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'Building a PC, creating playlists, sneaker culture, anime story arcs…';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  },
  {
    id: 'rolemodel',
    title: 'Who inspires you and why?',
    hint: 'Could be someone you know or admire from afar. Focus on their qualities.',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'A teacher, a family member, an artist, an activist… and why they resonate.';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  },
  {
    id: 'teach',
    title: 'If you could teach your classmates one skill or insight, what would it be?',
    hint: 'Think of something practical or eye‑opening you know well.',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'How to budget for a month, how to properly warm up before workouts, how to spot fake news…';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  },
  {
    id: 'archetype',
    title: 'Which Jungian archetype resonates with you most right now?',
    hint: 'Select the character pattern you feel aligned with today.  This helps tailor follow‑up prompts and seeds.',
    render(target, value = []) {
      const opts = [
        'Explorer', 'Caregiver', 'Hero', 'Creator', 'Sage', 'Rebel', 'Innocent', 'Ruler'
      ];
      // Use chip selector for archetypes; allow one selection.
      const chips = createChips(opts, Array.isArray(value) ? value : []);
      // Enforce single selection by toggling off others on click
      chips.querySelectorAll('.chip').forEach(btn => {
        btn.onclick = () => {
          const wasActive = btn.classList.contains('active');
          chips.querySelectorAll('.chip').forEach(b => b.classList.remove('active'));
          btn.classList.toggle('active', !wasActive);
        };
      });
      target.appendChild(chips);
      return () => chips.getValue();
    }
  },
  {
    id: 'values',
    title: 'Select your core values (2–4)',
    hint: 'What principles must stay intact for you to feel right?',
    render(target, value = []) {
      const valOpts = ['curiosity','creativity','fairness','courage','kindness','precision','freedom','belonging','adventure','stability','growth','justice','playfulness','excellence'];
      const chips = createChips(valOpts, Array.isArray(value) ? value : []);
      target.appendChild(chips);
      return () => chips.getValue();
    }
  },
  {
    id: 'responsible',
    title: 'Who or what do you feel responsible to/for?',
    hint: 'This guides audience fit and purpose. Pick a few.',
    render(target, value = []) {
      const opts = ['first‑gen students','immigrants','ESL learners','athletes','gamers','artists','parents','caregivers','local businesses','environment','community health','social justice','STEM beginners'];
      const chips = createChips(opts, Array.isArray(value) ? value : []);
      target.appendChild(chips);
      return () => chips.getValue();
    }
  }
];

// Adaptive follow‑up question templates keyed by category
const adaptivePrompts = {
  arts: {
    title: 'Creativity follow‑up',
    hint: 'How does creativity show up in your life, and why does it matter to you?',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'Describe a creative moment that lit you up. What medium? What feeling?';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  },
  helping: {
    title: 'Helping follow‑up',
    hint: 'Describe a time you supported someone and felt a deep sense of purpose.',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'Tutoring a peer, comforting a friend, volunteering at a shelter…';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  },
  tech: {
    title: 'Technology follow‑up',
    hint: 'What technology excites or frustrates you, and what do people around you misunderstand about it?',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'AI ethics, smartphone dependency, robotics in healthcare…';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  },
  nature: {
    title: 'Nature follow‑up',
    hint: 'Share a moment in nature that made you feel connected or reflective.',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'Sitting by a river, watching a sunset, tending a garden…';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  },
  health: {
    title: 'Wellness follow‑up',
    hint: 'How have wellness or health topics shaped your life or those you care about?',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'Managing anxiety, learning nutrition, discovering a sport…';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  },
  justice: {
    title: 'Justice follow‑up',
    hint: 'What issue ignites your sense of fairness or equity? Why does it matter to you?',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'Racial justice, LGBTQ+ rights, housing equality, environmental justice…';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  },
  business: {
    title: 'Enterprise follow‑up',
    hint: 'If you could build a venture to solve a problem you care about, what would it be and why?',
    render(target, value = '') {
      const ta = document.createElement('textarea');
      ta.placeholder = 'A non‑profit for youth financial literacy, a social enterprise for upcycled fashion…';
      ta.value = value;
      target.appendChild(ta);
      return () => ta.value.trim();
    }
  }
};

// Current question list (core + adaptives)
let questions = [];

// DOM references
const introSection = document.getElementById('intro');
const engineSection = document.getElementById('engine');
const resultsSection = document.getElementById('results');
const qnumEl = document.getElementById('qnum');
const qtitleEl = document.getElementById('qtitle');
const qhintEl = document.getElementById('qhint');
const qbodyEl = document.getElementById('qbody');
const barEl = document.getElementById('bar');
const progressLabelEl = document.getElementById('progressLabel');

// Buttons
const startBtn = document.getElementById('start');
const loadBtn = document.getElementById('load');
const clearBtn = document.getElementById('clear');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const skipBtn = document.getElementById('skip');
const exportBtn = document.getElementById('export');
const saveBtn = document.getElementById('save');
const restartBtn = document.getElementById('restart');

// Render current question
let currentGetter = null;
function renderQuestion() {
  const q = questions[state.index];
  qnumEl.textContent = state.index + 1;
  qtitleEl.textContent = q.title;
  qhintEl.textContent = q.hint || '';
  qbodyEl.innerHTML = '';
  currentGetter = q.render(qbodyEl, state.answers[q.id]);
  const pct = Math.round(state.index / questions.length * 100);
  barEl.style.width = pct + '%';
  progressLabelEl.textContent = pct + '%';
  prevBtn.disabled = state.index === 0;
}

// Advance to next question or finish
function nextQuestion(skip = false) {
  const q = questions[state.index];
  if (!skip) {
    state.answers[q.id] = currentGetter();
  }
  if (state.index < questions.length - 1) {
    state.index++;
    renderQuestion();
  } else {
    // finished all questions
    synthesize();
  }
}

function prevQuestion() {
  if (state.index > 0) {
    state.index--;
    renderQuestion();
  }
}

// Begin the questionnaire
function begin() {
  questions = [...coreQuestions];
  state.index = 0;
  introSection.hidden = true;
  resultsSection.hidden = true;
  engineSection.hidden = false;
  renderQuestion();
}

// Save state to localStorage
function saveProgress() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ answers: state.answers }));
  const badge = document.createElement('span');
  badge.className = 'badge good';
  badge.textContent = 'Saved';
  saveBtn.after(badge);
  setTimeout(() => badge.remove(), 1500);
}

// Load saved progress
function loadProgress() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (!saved) return;
  try {
    const data = JSON.parse(saved);
    state.answers = data.answers || {};
    alert('Saved progress loaded. Click “Begin” to resume.');
  } catch(err) {
    console.error(err);
  }
}

// Clear saved progress
function clearProgress() {
  if (confirm('This will clear all saved answers. Proceed?')) {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
}

// Detect categories based on textual answers
function detectCategories(text) {
  const lower = text.toLowerCase();
  const scores = {};
  Object.keys(keywords).forEach(cat => {
    scores[cat] = keywords[cat].reduce((sum, kw) => sum + (lower.includes(kw) ? 1 : 0), 0);
  });
  // Boost categories based on selected archetype.  Each selected archetype
  // contributes +2 to its mapped categories, ensuring they appear among
  // detected categories even if keywords are absent.
  try {
    const arcAns = state.answers['archetype'];
    if (Array.isArray(arcAns)) {
      arcAns.forEach(name => {
        const cats = archetypeCategories[name] || [];
        cats.forEach(cat => {
          scores[cat] = (scores[cat] || 0) + 2;
        });
      });
    }
  } catch(e) {}
  return Object.entries(scores)
    .filter(([,score]) => score > 0)
    .sort((a,b) => b[1] - a[1])
    .slice(0,2)
    .map(([cat]) => cat);
}

// Generate synthesis and adaptive questions
function synthesize() {
  // Determine if adaptives have been asked
  if (!state.answers._adapted) {
    const combined = [state.answers.childhood, state.answers.flow, state.answers.topics, state.answers.speak30, state.answers.rolemodel, state.answers.teach].filter(Boolean).join(' ');
    const cats = detectCategories(combined);
    // Build new question list with adaptives appended
    const adaptives = cats.map(cat => {
      const tmpl = adaptivePrompts[cat];
      return {
        id: 'adaptive_' + cat,
        title: tmpl.title,
        hint: tmpl.hint,
        render: tmpl.render
      };
    });
    questions = [...coreQuestions, ...adaptives];
    state.answers._adapted = true;
    state.index = coreQuestions.length;
    renderQuestion();
    return;
  }
  // Final synthesis
  engineSection.hidden = true;
  resultsSection.hidden = false;
  // Purpose hypotheses
  const hypothesesEl = document.getElementById('hypotheses');
  hypothesesEl.innerHTML = '';
  const purposeLines = [];
  const vals = state.answers.values || [];
  const resp = state.answers.responsible || [];
  const role = state.answers.rolemodel || '';
  const challenge = state.answers.challenge || '';
  if (resp.length && vals.length) {
    purposeLines.push(`Support ${resp.slice(0,2).join(' & ')} by living your values of ${vals.slice(0,2).join(' & ')}.`);
  }
  if (challenge) {
    purposeLines.push(`Share what you learned from overcoming your challenge (“${challenge.substring(0,60)}…” ) to help peers facing similar struggles.`);
  }
  if (role) {
    const firstWords = role.split(/[ ,;.]+/).slice(0,3).join(', ');
    purposeLines.push(`Embody the qualities of your inspiration (e.g., ${firstWords}) as you inform and uplift others.`);
  }
  if (!purposeLines.length) {
    purposeLines.push('Use your interests and experiences to bring light to a topic that matters to this class.');
  }
  purposeLines.forEach(line => {
    const li = document.createElement('li');
    li.textContent = line;
    hypothesesEl.appendChild(li);
  });
  // Topic seeds
  // Build topic seeds array from student's inputs and detected interests.  We
  // start with user‑provided world issues and personal topics, then fill
  // remaining slots with suggestions based on categories and archetype.
  const seeds = [];
  const rawTopics = state.answers.topics || '';
  rawTopics.split(/[,;\n]+/)
    .map(s => s.trim())
    .filter(Boolean)
    .slice(0,3)
    .forEach(item => {
      seeds.push(item.charAt(0).toUpperCase() + item.slice(1));
    });
  if (seeds.length < 3) {
    const rawSpeak = state.answers.speak30 || '';
    rawSpeak.split(/[,;\n]+/)
      .map(s => s.trim())
      .filter(Boolean)
      .forEach(item => {
        if (seeds.length < 3) seeds.push(item.charAt(0).toUpperCase() + item.slice(1));
      });
  }
  // Add suggestions from detected categories.  Use the mapping defined above
  // to pick topics appropriate to the student’s interest areas.  Avoid
  // duplicates by checking existing seeds.  Only add until we have three.
  const cats = detectCategories(combinedText());
  cats.forEach(cat => {
    const list = seedSuggestions[cat] || [];
    for (let i = 0; i < list.length && seeds.length < 3; i++) {
      const candidate = list[i];
      if (!seeds.includes(candidate)) {
        seeds.push(candidate);
      }
    }
  });
  // If we still have fewer than three seeds, fill with generic informative topics
  const genericSeeds = [
    'How deliberate practice builds skill',
    'The history of public speaking and its civic role',
    'How mindsets shape academic performance'
  ];
  genericSeeds.forEach(item => {
    if (seeds.length < 3 && !seeds.includes(item)) seeds.push(item);
  });
  // Render seeds
  const seedsEl = document.getElementById('seeds');
  seedsEl.innerHTML = '';
  seeds.slice(0,3).forEach(seed => {
    const li = document.createElement('li');
    li.textContent = seed;
    seedsEl.appendChild(li);
  });
  // Research questions: tailor each question using a short prompt about credible
  // sources and our class.  Include category hints if available.
  const rqsEl = document.getElementById('rqs');
  rqsEl.innerHTML = '';
  const rqList = seeds.slice(0,3).map(seed => {
    return `For ${seed.toLowerCase()}, what do credible sources say, and what does our class most need to understand (definition, process, comparison or another structure)?`;
  });
  rqList.forEach(q => {
    const li = document.createElement('li');
    li.textContent = q;
    rqsEl.appendChild(li);
  });
  // Outline starters: Provide a pattern and body for each seed.  Rotate
  // through Definition, Process, Comparison patterns.  You could extend this
  // list with Problem/Solution or Cause/Effect in future iterations.
  const outlinesEl = document.getElementById('outlines');
  outlinesEl.innerHTML = '';
  seeds.slice(0,3).forEach((seed, idx) => {
    const patterns = ['Definition','Process','Comparison'];
    const pattern = patterns[idx % patterns.length];
    let body = '';
    if (pattern === 'Definition') body = `Term → plain definition → 2 key properties → 1 campus example → a limitation to note.`;
    if (pattern === 'Process') body = `Step 1 → Step 2 → Step 3, with “why it matters” after each step.`;
    if (pattern === 'Comparison') body = `Item A vs Item B → 2 similarities → 2 differences → which suits our class and why.`;
    const div = document.createElement('div');
    div.className = 'card';
    const audLine = resp && resp.length ? `For our class, this matters because we care about ${resp[0]}.` : 'For our class, this matters because it is practical for us.';
    div.innerHTML = `<strong>${pattern} pattern — ${seed}</strong><br><span class="muted">Audience line: ${audLine}</span><br><span class="small">${body}</span>`;
    outlinesEl.appendChild(div);
  });
}

function combinedText() {
  return [state.answers.childhood, state.answers.flow, state.answers.topics, state.answers.speak30, state.answers.rolemodel, state.answers.teach].filter(Boolean).join(' ');
}

// Export summary as text
function exportSummary() {
  const name = (state.answers.name || 'student').replace(/\s+/g,'_');
  const lines = [];
  lines.push(`Presenter Card — ${state.answers.name || ''}`);
  lines.push('='.repeat(40));
  const resp = state.answers.responsible || [];
  lines.push('Audience line: ' + (resp.length ? 'For our class, this matters because we care about ' + resp[0] + '.' : 'For our class, this matters because it is practical for us.'));
  lines.push('');
  lines.push('Purpose hypotheses:');
  document.querySelectorAll('#hypotheses li').forEach(li => lines.push('- ' + li.textContent));
  lines.push('');
  lines.push('Topic seeds:');
  document.querySelectorAll('#seeds li').forEach((li,i) => lines.push(`${i+1}. ${li.textContent}`));
  lines.push('');
  lines.push('Research questions:');
  document.querySelectorAll('#rqs li').forEach((li,i) => lines.push(`${i+1}. ${li.textContent}`));
  lines.push('');
  lines.push('Outline starters:');
  document.querySelectorAll('#outlines .card').forEach(div => {
    const title = div.querySelector('strong').textContent;
    const body = div.querySelector('.small').textContent;
    lines.push(`• ${title} — ${body}`);
  });
  lines.push('');
  lines.push('Speakable oral citation template:');
  lines.push('According to [who], in [year], in [source], [finding]. For our class this matters because [audience fit].');
  const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${name}_purpose_topic.txt`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// Event listeners
startBtn.onclick = () => begin();
loadBtn.onclick = () => loadProgress();
clearBtn.onclick = () => clearProgress();
prevBtn.onclick = () => prevQuestion();
nextBtn.onclick = () => nextQuestion(false);
skipBtn.onclick = () => nextQuestion(true);
saveBtn.onclick = () => saveProgress();
exportBtn.onclick = () => exportSummary();
restartBtn.onclick = () => {
  if (confirm('Start over and clear current session?')) location.reload();
};

// Prefill answers from saved state, if any
const saved = localStorage.getItem(STORAGE_KEY);
if (saved) {
  try {
    const parsed = JSON.parse(saved);
    state.answers = parsed.answers || {};
  } catch(e) {}
}
</script>
</body>
</html>